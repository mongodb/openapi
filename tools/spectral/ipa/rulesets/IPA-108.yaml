# IPA-108: Delete
# https://mongodb.github.io/ipa/108

aliases:
  DeleteOperationObject:
    - '$.paths[*].delete'

rules:
  xgen-IPA-108-delete-response-should-be-empty:
    description: |
      Delete method response should not have schema reference to object.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies to 204 responses in DELETE methods for single resource endpoints (with path parameters)
        - Verifies that the response does not contain a schema property
        - Fails if any content type in the response has a defined schema as reference
        - Skips validation for collection endpoints (without path parameters)
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-108-delete-response-should-be-empty'
    severity: error
    given: '#DeleteOperationObject.responses[204]'
    then:
      function: IPA108DeleteMethodResponseShouldNotHaveSchema

  xgen-IPA-108-delete-method-return-204-response:
    description: |
      DELETE method must return 204 No Content.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies to all DELETE methods for single resource endpoints (with path parameters)
        - Verifies the 204 No Content response code is present
        - Fails if the method lacks a 204 No Content response or defines a different 2xx status code
        - Ensures no other 2xx response codes are defined
        - Fails if the 204 status code is missing or if other 2xx responses exist
        - Skips validation for collection endpoints (without path parameters)
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-108-delete-method-return-204-response'
    severity: error
    given: '#DeleteOperationObject'
    then:
      function: IPA108DeleteMethod204Response

  xgen-IPA-108-delete-request-no-body:
    description: |
      DELETE method must not have request body.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies to all DELETE methods for single resource endpoints (with path parameters)
        - Verifies that the operation object does not contain a requestBody property
        - Fails if any requestBody is defined for the DELETE method
        - Skips validation for collection endpoints (without path parameters)
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-108-delete-request-no-body'
    severity: error
    given: '#DeleteOperationObject'
    then:
      function: IPA108DeleteMethodNoRequestBody
  xgen-IPA-108-readonly-resource-should-not-have-delete-method:
    description: |
      Read-only resources must not define the Delete method.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies to DELETE methods on single resource paths and singleton resources
        - Checks if the resource is a read-only resource (all properties in GET response have readOnly:true)
        - If a resource does not have a standard GET method, it is not considered read-only (cannot determine the resource schema)
        - Fails if a Delete method is defined on a read-only resource
        - Operation objects with `x-xgen-IPA-exception` for this rule are excluded from validation
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-108-readonly-resource-should-not-have-delete-method'
    severity: error
    given: '#DeleteOperationObject'
    then:
      function: 'IPA108ReadOnlyResourceShouldNotHaveDeleteMethod'
  xgen-IPA-108-valid-operation-id:
    description: |
      The Operation ID must start with the verb “delete” and should be followed by a noun or compound noun.
      The noun(s) in the Operation ID should be the collection identifiers from the resource identifier in singular form.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to DELETE methods that are not [custom methods](https://mongodb.github.io/ipa/109)
        - Confirms that the existing OperationId is compliant with generated IPA Compliant OperationId
      ##### Configuration
      This rule includes two configuration options:
        - `methodName`: The verb to be used in the OperationIds
        - `ignoreSingularizationList`: Words that are allowed to maintain their assumed plurality (e.g., "Fts")
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-108-valid-operation-id'
    severity: error
    given: '#DeleteOperationObject'
    then:
      function: 'IPA108ValidOperationID'
      functionOptions:
        methodName: 'delete'
        ignoreSingularizationList:
          - 'Fts'
  xgen-IPA-108-operation-id-length:
    description: |
      The Operation ID should not be longer than 4 words. If the generated operation ID exceeds 4 words,
      add an 'x-xgen-operation-id-override' extension with a shorter operation ID.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to DELETE methods that are not [custom methods](https://mongodb.github.io/ipa/109)
        - Verifies that the operation ID is not longer than 4 words
        - If the operation ID is longer than 4 words, requires an 'x-xgen-operation-id-override' extension
        - Can be exempted using 'x-xgen-IPA-exception' for APIs where long operation IDs are intentional

      ##### Configuration
      This rule includes three configuration options:
        - `methodName`: The verb to be used in the OperationIds
        - `ignoreSingularizationList`: Words that are allowed to maintain their assumed plurality (e.g., "Fts")
        - `maxLength`: The maximum number of words allowed in the operation ID (default: 4)
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-108-operation-id-length'
    severity: error
    given: '#DeleteOperationObject'
    then:
      function: 'IPA108OperationIdLength'
      functionOptions:
        methodName: 'delete'
        ignoreSingularizationList:
          - 'Fts'
        maxLength: 4

functions:
  - IPA108DeleteMethodResponseShouldNotHaveSchema
  - IPA108DeleteMethod204Response
  - IPA108DeleteMethodNoRequestBody
  - IPA108ReadOnlyResourceShouldNotHaveDeleteMethod
  - IPA108ValidOperationID
  - IPA108OperationIdLength
