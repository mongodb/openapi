# IPA-105: List
# http://go/ipa/105

functions:
  - listResponseCodeShouldBe200OK
  - listMethodHasNoRequestBody
  - eachResourceHasListMethod
  - listMethodResponseIsGetMethodResponse

rules:
  xgen-IPA-105-list-method-response-code-is-200:
    description: 'The List method must return a 200 OK response. http://go/ipa/105'
    message: '{{error}} http://go/ipa/105'
    severity: warn
    given: '$.paths[*].get'
    then:
      function: 'listResponseCodeShouldBe200OK'
  xgen-IPA-105-list-method-no-request-body:
    description: 'The List method request must not include a body. http://go/ipa/105'
    message: '{{error}} http://go/ipa/105'
    severity: warn
    given: '$.paths[*].get'
    then:
      function: 'listMethodHasNoRequestBody'
  xgen-IPA-105-resource-has-list:
    description: 'APIs must provide a List method for resources. http://go/ipa/105'
    message: '{{error}} http://go/ipa/105'
    severity: warn
    given: '$.paths'
    then:
      field: '@key'
      function: 'eachResourceHasListMethod'
  xgen-IPA-105-list-method-response-is-get-method-response:
    description: >-
      The response body of the List method should consist of the same resource object returned by the Get method.

      ##### Implementation details

      Validation checks that the List method response contains items property with reference to the same schema as the Get method response.

        - Validation applies to List methods for resource collections only
        - Validation applies to json response content only
        - Validation ignores responses without schema and non-paginated responses
          - A response is considered paginated if it contains an array property named `results`
        - Validation ignores resources without a Get method
        - Paths with `x-xgen-IPA-exception` for this rule are excluded from validation
    message: '{{error}} http://go/ipa-spectral#IPA-105'
    severity: warn
    given: '$.paths[*].get.responses[*].content'
    then:
      field: '@key'
      function: 'listMethodResponseIsGetMethodResponse'
