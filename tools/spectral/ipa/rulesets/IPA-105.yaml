# IPA-105: List
# https://mongodb.github.io/ipa/105

functions:
  - IPA105ListResponseCodeShouldBe200OK
  - IPA105ListMethodHasNoRequestBody
  - IPA105EachResourceHasListMethod
  - IPA105ListMethodResponseIsGetMethodResponse
  - IPA105ValidOperationID
  - IPA105OperationIdLength

aliases:
  GetOperationObject:
    - '$.paths[*].get'

rules:
  xgen-IPA-105-list-method-response-code-is-200:
    description: |
      The List method must return a 200 OK response.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to GET methods on resource collection paths
        - Ignores singleton resources
        - Verifies the 200 OK response code is present
        - Fails if the method lacks a 200 OK response or defines a different 2xx status code
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-105-list-method-response-code-is-200'
    severity: error
    given: '#GetOperationObject'
    then:
      function: 'IPA105ListResponseCodeShouldBe200OK'
  xgen-IPA-105-list-method-no-request-body:
    description: |
      The List method request must not include a body.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to GET methods on resource collection paths
        - Ignores singleton resources
        - Verifies that the operation object does not contain a requestBody property
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-105-list-method-no-request-body'
    severity: error
    given: '#GetOperationObject'
    then:
      function: 'IPA105ListMethodHasNoRequestBody'
  xgen-IPA-105-resource-has-list:
    description: |
      APIs must provide a List method for resources.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to resource collection paths
        - Ignores singleton resources
        - Verifies the resource path has a GET method
        - Fails if the resource path does not have a GET method
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-105-resource-has-list'
    severity: error
    given: '$.paths'
    then:
      field: '@key'
      function: 'IPA105EachResourceHasListMethod'
  xgen-IPA-105-list-method-response-is-get-method-response:
    description: >-
      The response body of the List method should consist of the same resource object returned by the Get method.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to resource collection paths with JSON content types
        - Ignores singleton resources
        - Ignores responses without a schema or non-paginated responses
        - A response is considered paginated if it has a schema with a 'results' array property
        - Verifies that the schema of items in the 'results' array matches the schema used in the Get method response
        - Fails if the Get method doesn't have a schema reference or if the schemas don't match
        - Validation ignores resources without a Get method
        - Paths with `x-xgen-IPA-exception` for this rule are excluded from validation
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-105-list-method-response-is-get-method-response'
    severity: error
    given: '#GetOperationObject.responses.200.content'
    then:
      field: '@key'
      function: 'IPA105ListMethodResponseIsGetMethodResponse'
  xgen-IPA-105-valid-operation-id:
    description: |
      The Operation ID must start with the verb “list” and should be followed by a noun or compound noun.
      The noun(s) in the Operation ID should be the collection identifiers from the resource identifier in singular form, where the last noun is in plural form.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to GET methods on resource collection paths
        - Ignores singleton resources
        - Confirms that the existing OperationId is compliant with generated IPA Compliant OperationId

      ##### Configuration
      This rule includes three configuration options:
        - `methodName`: The verb to be used in the OperationIds
        - `ignoreSingularizationList`: Words that are allowed to maintain their assumed plurality (e.g., "Fts")
        - `maxLength`: The maximum number of words allowed in the operation ID override (default: 4)
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-105-valid-operation-id'
    severity: error
    given: '#GetOperationObject'
    then:
      function: 'IPA105ValidOperationID'
      functionOptions:
        methodName: 'list'
        ignoreSingularizationList:
          - 'Fts'
        maxLength: 4
  xgen-IPA-105-operation-id-length:
    description: |
      The Operation ID should not be longer than 4 words. If the generated operation ID exceeds 4 words,
      add an 'x-xgen-operation-id-override' extension with a shorter operation ID.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to GET methods on resource collection paths
        - Ignores singleton resources
        - Verifies that the operation ID is not longer than 4 words
        - If the operation ID is longer than 4 words, requires an 'x-xgen-operation-id-override' extension
        - Can be exempted using 'x-xgen-IPA-exception' for APIs where long operation IDs are intentional

      ##### Configuration
      This rule includes three configuration options:
        - `methodName`: The verb to be used in the OperationIds
        - `ignoreSingularizationList`: Words that are allowed to maintain their assumed plurality (e.g., "Fts")
        - `maxLength`: The maximum number of words allowed in the operation ID (default: 4)
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-105-operation-id-length'
    severity: error
    given: '#GetOperationObject'
    then:
      function: 'IPA105OperationIdLength'
      functionOptions:
        methodName: 'list'
        ignoreSingularizationList:
          - 'Fts'
        maxLength: 4
