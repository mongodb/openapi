# IPA-113: Singleton Resources
# https://mongodb.github.io/ipa/113

functions:
  - IPA113SingletonHasNoId
  - IPA113SingletonHasNoDeleteMethod
  - IPA113SingletonHasUpdateMethod
  - IPA113ResetMethodMustUsePost
  - IPA113ResetMethodMustNotHaveRequestBody
  - IPA113ResetMethodMustReturn200OK
  - IPA113ResetMethodResponseIsGetMethodResponse
  - IPA113ResetMethodOnlyOnSingletonResources
  - IPA113ResetMethodNotOnReadonlySingleton
  - IPA113ResetMethodValidOperationID

rules:
  xgen-IPA-113-singleton-must-not-have-id:
    description: |
      Singleton resources must not have a user-provided or system-generated ID.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to singleton resources that are identified as resource collection identifiers
        - Checks that the resource has a GET method defined
        - Examines all 2xx response schemas from the GET method
        - Verifies that no schema contains 'id' or '_id' properties in their object definitions
        - Fails if any response schema contains these identifier properties
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-singleton-must-not-have-id'
    severity: error
    given: '$.paths[*]'
    then:
      function: 'IPA113SingletonHasNoId'
  xgen-IPA-113-singleton-must-not-have-delete-method:
    description: |
      Singleton resources must not define the Delete standard method.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to singleton resources
        - Checks that the resource does not have a DELETE method defined
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-singleton-must-not-have-delete-method'
    severity: error
    given: '$.paths[*]'
    then:
      function: 'IPA113SingletonHasNoDeleteMethod'
  xgen-IPA-113-singleton-should-have-update-method:
    description: |
      Singleton resources should define the Update method. Validation for the presence of Get method is covered by IPA-104 (see [xgen-IPA-104-resource-has-GET](https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-104-resource-has-GET)).

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to singleton resources
        - Excludes read-only singleton resources (where all properties in the GET response schema are marked as readOnly; for List responses, all properties in the items schema must be readOnly)
        - Checks that the resource has the PUT and/or PATCH methods defined
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-singleton-should-have-update-method'
    severity: error
    given: '$.paths[*]'
    then:
      function: 'IPA113SingletonHasUpdateMethod'
  xgen-IPA-113-reset-method-must-use-POST:
    description: |
      The :reset custom method must use the POST HTTP method.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to paths ending with :reset
        - Verifies that only POST method is defined
        - Fails if GET or any other HTTP method is used
        - Fails if multiple HTTP methods are defined for the same :reset endpoint
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-must-use-POST'
    severity: warn
    given: '$.paths[*]'
    then:
      function: 'IPA113ResetMethodMustUsePost'
  xgen-IPA-113-reset-method-must-not-have-request-body:
    description: |
      The :reset custom method must not have a request body.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to POST methods on paths ending with :reset
        - Verifies that the operation object does not contain a requestBody property
        - Fails if any request body is defined
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-must-not-have-request-body'
    severity: warn
    given: '$.paths[*].post'
    then:
      function: 'IPA113ResetMethodMustNotHaveRequestBody'
  xgen-IPA-113-reset-method-must-return-200-OK:
    description: |
      The :reset custom method must return a 200 OK response with the reset resource in the response body.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to POST methods on paths ending with :reset
        - Verifies that a 200 OK response code is present
        - Fails if the method lacks a 200 OK response or defines a different 2xx status code
        - Verifies that the 200 response has a response body with schema
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-must-return-200-OK'
    severity: warn
    given: '$.paths[*].post'
    then:
      function: 'IPA113ResetMethodMustReturn200OK'
  xgen-IPA-113-reset-method-response-is-get-method-response:
    description: |
      The :reset custom method response must match the GET method response schema.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to POST methods on paths ending with :reset
        - Applies only to JSON response content types
        - Verifies that both :reset and GET methods have schema references
        - Confirms that the :reset method 200 response schema reference matches the GET method response schema reference
        - Ensures the reset resource returned is the same type as the singleton resource
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-response-is-get-method-response'
    severity: warn
    given: '$.paths[*].post.responses.200.content'
    then:
      field: '@key'
      function: 'IPA113ResetMethodResponseIsGetMethodResponse'
  xgen-IPA-113-reset-method-only-on-singleton-resources:
    description: |
      The :reset custom method must only be defined on singleton resources.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to paths ending with :reset
        - Verifies that the parent path (without :reset) is a singleton resource
        - Uses existing isSingletonResource() helper function
        - Fails if :reset is defined on a non-singleton resource
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-only-on-singleton-resources'
    severity: warn
    given: '$.paths[*]'
    then:
      function: 'IPA113ResetMethodOnlyOnSingletonResources'
  xgen-IPA-113-reset-method-not-on-readonly-singleton:
    description: |
      Read-only singleton resources must not define a :reset custom method.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to paths ending with :reset
        - Verifies that the parent singleton resource is not read-only
        - Uses existing isReadOnlyResource() helper function
        - Fails if the singleton resource has all properties marked as readOnly: true
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-not-on-readonly-singleton'
    severity: warn
    given: '$.paths[*]'
    then:
      function: 'IPA113ResetMethodNotOnReadonlySingleton'
  xgen-IPA-113-reset-method-valid-operation-id:
    description: |
      The :reset custom method must have a valid operation ID.

      ##### Implementation details
      Rule checks for the following conditions:
        - Applies only to POST methods on paths ending with :reset
        - Confirms that the operation ID follows the pattern: reset{ResourceName}
        - Uses existing operation ID validation infrastructure

      ##### Configuration
      This rule includes a configuration option:
        - `ignoreSingularizationList`: Words that are allowed to maintain their assumed plurality (e.g., "Fts")
    message: '{{error}} https://mdb.link/mongodb-atlas-openapi-validation#xgen-IPA-113-reset-method-valid-operation-id'
    severity: warn
    given: '$.paths[*].post'
    then:
      function: 'IPA113ResetMethodValidOperationID'
      functionOptions:
        ignoreSingularizationList:
          - 'Fts'
