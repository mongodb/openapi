name: Postman Release
on:
  workflow_call:
    inputs:
      atlas_prod_base_url:
        description: 'Base URL of Atlas.'
        required: true
        type: string
    secrets: # all secrets are passed explicitly in this workflow
      postman_api_key:
        required: true
      workspace_id:
        required: true
  workflow_dispatch:
permissions:
  issues: write

jobs:
  release-postman:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch OpenAPI Specification
        working-directory: ./tools/postman
        run: |
          make fetch_openapi

      - name: Convert the OpenAPI Specification into Collection
        id: convert
        working-directory: ./tools/postman
        run: |
          make convert_to_collection

      - name: Create Issue
        if: ${{ failure() && steps.convert.outcome == 'failure' }}
        uses: imjohnbo/issue-bot@572eed14422c4d6ca37e870f97e7da209422f5bd
        with:
          labels: failed-release
          title: "Postman Release: `make convert_to_collection` command failed :scream_cat:"
          body: See https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Transform Postman Collection 
        id: transform
        env:
          BASE_URL: ${{ inputs.atlas_prod_base_url }}
        working-directory: ./tools/postman
        run: |
          make transform_collection

      - name: Create Issue
        if: ${{ failure() && steps.transform.outcome == 'failure' }}
        uses: imjohnbo/issue-bot@572eed14422c4d6ca37e870f97e7da209422f5bd
        with:
          labels: failed-release
          title: "Postman Release: `make transform_collection` command failed :scream_cat:"
          body: See https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Collection to Postman
        env:
          POSTMAN_API_KEY: ${{ secrets.postman_api_key }}
          WORKSPACE_ID: ${{ secrets.workspace_id }}
        working-directory: ./tools/postman
        run: |
          make upload_collection
