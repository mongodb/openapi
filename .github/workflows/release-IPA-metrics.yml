# This workflow will generate metrics about the IPA validation on the current OAS
# (number of adoptions, violations and exceptions) and upload the data to an S3 bucket.
name: IPA Validation Metrics Release
on:
  schedule:
    - cron: '0 22 * * *'  # Runs daily at 22:00 UTC (10 PM UTC)
  workflow_dispatch:
permissions:
  issues: write
env:
  NODE_VERSION: '20.x'
  WORKING_DIR: ./tools/spectral/ipa/metrics/scripts
  OAS_ENV: 'dev'
  OAS_BRANCH: 'main'

jobs:
  # Generates and uploads the IPA validation metrics to S3
  release-IPA-metrics:
    name: Release IPA Validation Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: $NODE_VERSION
          cache: 'npm'

      - name: Install npm dependencies
        run: npm install

      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          ref: $OAS_BRANCH
          token: ${{secrets.API_BOT_PAT}}

      - name: Upload current Specs and Changelog files
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
        with:
          name: base-$OAS_ENV
          retention-days: 1
          path: |
            openapi/v2/openapi*.json
            changelog/changelog.json
            changelog/internal/changelog-all.json
            changelog/internal/metadata.json  

      - name: Download openapi-foas
        uses: actions/download-artifact@v4
        with:
          name: openapi-foas-$OAS_ENV
          github-token: ${{ secrets.API_BOT_PAT }}

      - name: Run Metric Collection Job
        working-directory: $WORKING_DIR
        run: node runMetricCollection.js ../../../../../openapi-foas.json

      - name: Dump Metric Collection Job Data to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.IPA_S3_BUCKET_DW_STAGING_USERNAME }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.IPA_S3_BUCKET_DW_STAGING_PASSWORD }}
          S3_BUCKET_PREFIX: ${{ secrets.IPA_S3_BUCKET_DW_STAGING_PREFIX }}
        working-directory: $WORKING_DIR
        run: node dataDump.js

  failure-handler:
    name: Failure Handler
    needs: [ release-IPA-metrics ]
    if: ${{ failure() }}
    uses: ./.github/workflows/failure-handler.yml
    with:
      env: $OAS_ENV
      release_name: "IPA Metrics"
    secrets:
      jira_api_token: ${{ secrets.JIRA_API_TOKEN }}
