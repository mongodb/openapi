name: Release the OpenAPI spec to Bump.sh
on:
  workflow_call:
    inputs:
      env:
        description: 'Environment to release the OpenAPI Spec to.'
        required: true
        type: string
      atlas_admin_v1_doc_id:
        description: 'Bump Doc ID for the v1 spec'
        required: true
        type: string
      atlas_admin_v2_doc_id:
        description: 'Bump Doc ID for the v2 specs'
        required: true
        type: string
      branch:
        description: 'Branch to release the OpenAPI Spec to.'
        required: true
        type: string
    secrets:
      api_bot_pat:
        required: true
      bump_token:
        required: true

permissions:
  contents: read

jobs:
  create-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          token: ${{secrets.api_bot_pat}}
      - name: Setup Node
        uses: actions/setup-node@v4
      - name: Generate matrix
        id: set-matrix
        env:
          ATLAS_ADMIN_V1_DOC_ID: ${{ inputs.atlas_admin_v1_doc_id }}
          ATLAS_ADMIN_V2_DOC_ID: ${{ inputs.atlas_admin_v1_doc_id }}
          BRANCH_NAME: ${{ inputs.branch }}
        run: |
          spec_mapping=$(node .github/scripts/generateSpecMapping.js)
          echo "matrix=$spec_mapping" >> "$GITHUB_OUTPUT"

  deploy-doc:
    needs: create-matrix
    name: Deploy API documentation on Bump.sh
    strategy:
      matrix: 
        spec-mapping: ${{ fromJson(needs.create-matrix.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          token: ${{secrets.api_bot_pat}}
      - name: Deploy API documentation - ${{inputs.branch}}
        uses: bump-sh/github-action@59eaae922e81ac8d127bd2b2ac6dc4804bda8a4c
        with:
          doc: ${{matrix.spec-mapping.doc}}
          token: ${{secrets.bump_token}}
          file: ${{matrix.spec-mapping.file}}
          branch: ${{matrix.spec-mapping.branch}}

# We don't need to preview the API since the PR is autogenerated and always merge into master
# we will migrate this logic to another workflow that can be trigger ondemand by adding a label to a PR.
#  api-preview:
#    needs: create-matrix
#    if: ${{ github.event_name == 'pull_request'}}
#    name: Create API preview on Bump.sh
#    strategy:
#      matrix:
#        spec-mapping: ${{ fromJSON(needs.create-matrix.outputs.matrix) }}
#    runs-on: ubuntu-latest
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v4
#      - name: Create API preview
#        uses: bump-sh/github-action@59eaae922e81ac8d127bd2b2ac6dc4804bda8a4c
#        with:
#          doc: ${{matrix.spec-mapping.doc}}
#          token: ${{secrets.bump_token}}
#          file: ${{matrix.spec-mapping.file}}
#          branch: ${{matrix.spec-mapping.branch}}
#          command: preview
