name: 'Send a Slack Notification for upcoming release of API versions'

on:
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: '0 9 * * *' # Run once a day at 09:00 UTC

jobs:
  send-changelog-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (dev branch)
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          sparse-checkout:
            .github/scripts/upcoming_api_releases.sh
      - name: Check if there are upcoming API versions releases
        id: check-api-versions
        run: .github/scripts/upcoming_api_releases.sh
      - name: Get Start and End Dates
        if: steps.check-api-versions.outputs.api_versions != null
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID_APIX_2 }}
          SLACK_BEARER_TOKEN: ${{ secrets.SLACK_BEARER_TOKEN }}
          API_VERSIONS: ${{ steps.check-api-versions.outputs.api_versions }}
        run: |
          message_id=$(curl -X POST -H 'Authorization: Bearer '"${SLACK_BEARER_TOKEN}" \
          -H 'Content-type: application/json' \
          --data '{"channel":"'"${SLACK_CHANNEL_ID}"'","text":"The following API Versions are scheduled to be released in the next 3 weeks: '"${API_VERSIONS}"'. CC @apix-2-on-call","parse": "full",}' https://slack.com/api/chat.postMessage | jq '.ts')
          echo "message_id=${message_id}"
